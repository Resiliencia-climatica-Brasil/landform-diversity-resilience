var Biome = ee.FeatureCollection("projects/ee-lucasljardim9/assets/Biome");

var export_BBox = Biome
                  .map(function(feature){
                         return feature.bounds()
                      })
                  .geometry()
                  .dissolve({'maxError': 1})
                  .bounds();

//var biome_names = ["Amazônia", "Caatinga", "Cerrado", "Mata Atlântica", "Pampa", "Pantanal"];

var connectedness = ee.Image("projects/ee-lucasljardim9/assets/Biomas_resistencia_kernel");

var scale = connectedness.projection().nominalScale();
/*
var mean_biome = function(i, image){
  
  var statistics = image.rename("b1")
                   .reduceRegion({reducer: ee.Reducer.mean(), 
                                  geometry: Biome.filter(ee.Filter.eq("Bioma", i)), 
                                  scale: scale,
                                  maxPixels:1e13});
                                              
  return ee.Number(statistics.get("b1"));                            
}

var sq_sum_biome = function(i, image){
  
  var mean = image.reduceRegion({reducer:ee.Reducer.mean(), 
                                 geometry:Biome.filter(ee.Filter.eq("Bioma", i)), 
                                 maxPixels:1e13});
  
  var img_mean = ee.Image.constant(mean.get("b1"))
  
  var sq_dev = image.select("b1")
               .subtract(img_mean.select("constant"))
               .pow(2)
               .reduceRegion({reducer:ee.Reducer.sum(),
                              geometry:Biome.filter(ee.Filter.eq("Bioma", i)),
                              maxPixels:1e13});
                              
  return sq_dev;
}

var cell_number = function(i, image){
  
  var cells = image.reduceRegion({reducer:ee.Reducer.count(), 
                                  geometry:Biome,
                                  maxPixels:1e13});
                                                              
  var n = ee.Number(cells.get("b1"));
  
  return n;
}

var calculate_Z_scores = function(image){
  
  image = image.rename("b1");
  
  var mean = ee.Number(ee.List(biome_names.map(function(i){return mean_biome(i, image)}))
                       .reduce(ee.Reducer.mean())
                       );
  
  var list_sq_sum = ee.List(biome_names.map(function(i){return sq_sum_biome(i, image).get("b1")}));  
  
  var total_sq_sum = ee.Number(list_sq_sum.reduce(ee.Reducer.sum()));
  
  var n = ee.List(biome_names.map(function(i){return cell_number(i, image)}))
          .reduce(ee.Reducer.sum());  
  
  var std = total_sq_sum.divide(n).sqrt();
  
  var Z = image.subtract(mean)
          .divide(std);   
                      
  return Z                      
}
*/ 

var calculate_Z_scores = function(image) {
  // Calculate mean and standard deviation
  var mean = image.reduceRegion({
    reducer: ee.Reducer.mean(),
    scale: scale,
    bestEffort: true
  });//print('Global Mean', mean);

  var sd = image.reduceRegion({
    reducer: ee.Reducer.stdDev(),
    scale: scale,
    bestEffort: true
  });// print('Global sd', sd)

  // Extract the mean and standard deviation values from the dictionaries into a raster
var meanValue = ee.Image.constant(mean
                                  .values()
                                  .get(0));
                                  //print('mean Dictionary', meanValue);
                                  
  var sdValue = ee.Image.constant(sd
                                  .values()
                                  .get(0));
                                  //print('sd dictionary', sdValue);

  // Calculate z for the current image
  var z = image.subtract(meanValue).divide(sdValue);

  // Return the z image
  return z.rename('z');
};

var Z_connectedness = calculate_Z_scores(connectedness).multiply(-1);

Export.image.toAsset({image: Z_connectedness, 
                     description:"Z_connectedness",
                     assetId: "projects/ee-lucasljardim9/assets/Z_connectedness", 
                     pyramidingPolicy: "median", 
                     region: export_BBox, 
                     scale: scale,
                     maxPixels: 1e13});
